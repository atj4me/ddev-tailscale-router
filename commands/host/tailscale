#!/usr/bin/env bash

## #ddev-generated: If you want to edit and own this file, remove this line.
## Description: Tailscale command with launch/share functionality
## Usage: tailscale [launch|share|stat|proxy|url|args...]
## Example: "ddev tailscale launch" or "ddev tailscale share"


# Helper to run tailscale in the web container
tailscale_web() {
    ddev exec -s web tailscale "$@"
}

get_tailscale_url() {
    URL=$(ddev exec -s web bash -c 'tailscale status --peers=false --json | jq -r ".Self.DNSName" | sed "s/\.$//"')
    echo "https://$URL"
}

tailscale_login() {
    ddev exec -s web bash -c 'tailscale up --auth-key=$TS_AUTHKEY --hostname=$DDEV_SITENAME $TS_EXTRA_ARGS'
}

run_tailscale_share() {
    local cmd="$1"
    # Capture output
    output=$(tailscale_web "$cmd" --bg 127.0.0.1:$DDEV_ROUTER_HTTP_PORT)
    share_status=$?
    if [ $share_status -ne 0 ]; then
        tailscale_login
        run_tailscale_share "$cmd"
        exit 0
    fi
    # Replace the disable proxy instruction
    echo "$output" | sed "s/To disable the proxy, run: tailscale $cmd --https=443 off/To disable the proxy, run: ddev tailscale stop instead/"
}

stop_tailscale_share() {
    local cmd="$1"
    tailscale_web "$cmd" --https 443 off
}


CMD="serve"
if [ "$2" = "--public" ]; then
    echo -e "⚠️  Sharing your local development environment publicly can expose sensitive data. Ensure you understand the implications before proceeding."
    CMD="funnel"
fi

if [ "$1" = "login" ]; then
    tailscale_login
    exit 0
elif [ "$1" = "launch" ] || [ "$1" = "share" ] || [ $# -eq 0 ]; then

    run_tailscale_share "$CMD"
    sleep 1 # Give it a moment to start
    TAILSCALE_URL=$(get_tailscale_url)

    if [ -z "$TAILSCALE_URL" ]; then
        echo "Error: Could not retrieve Tailscale URL."
        exit 1
    fi

    ddev launch "$TAILSCALE_URL"
elif [  "$1" = "stop" ]; then
    stop_tailscale_share "$CMD"
elif [ "$1" = "stat" ]; then
    tailscale_web status --self --peers=false --active=true
elif [ "$1" = "proxystat" ]; then
    tailscale_web funnel status
elif [ "$1" = "url" ]; then
    get_tailscale_url
else
    tailscale_web "$@"
fi
